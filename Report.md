# Отчёт о выполнении задачи "Chemical-ICS"

- [Отчёт о выполнении задачи "Chemical-ICS"](#отчёт-о-выполнении-задачи-chemical-ics)
  - [Постановка задачи](#постановка-задачи)
  - [Общий алгоритм работы системы](#общий-алгоритм-работы-системы)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
  Для автоматизации работы с опасными химическими веществами на произвостве и снижения числа человеческих ошибок, приводящих к авариям, необходимо разработать прототип киберимунной АСУ смешивания компонентов (далее - АСУ), которая сможет проверять доступность требуемого в операции оборудования, соответсвие введенных рецептур установленным нормам и тех.процессу и по итогу отдавать команды на работу с реактивами.

## Общий алгоритм работы системы
1. Контролер составляет рецептуру, указывая вещества для смешивания и требуемое оборудование (out of scope).
2. Контролер вводит в АСУ рецептуру.
3. АСУ проверяет допустимость смешивания веществ между собой и допустимость смешивания на выбранном оборудовании: проведение операции или отказ.
4. АСУ печатает отчет об операции: идентификационные данные, сведения о используемых веществах и оборудовании, список проверенных норм с примечанием о (не)соответсвии норме.

## Известные ограничения и вводные

  По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.

### Цели и Предположения Безопасности (ЦПБ)
**Бизнес-цель:**
  - Выполнение заказа
**Цели безопасности:**
  - Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения.
  - Обеспечение целостности хранимых данных (баз данных и прочего).
  - Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
  - Исключение подмены решения системы.
  - Обеспечение доступности системы только для авторизованных лиц

**Предположения безопасности:**
 - Отсутсвует физическое воздействие на компоненты.
 - Отказоустойчивость компонента гарантируется самим компонентом. **Недостаточно четкий момент в постановке задачи, в дальнейшем хотелось бы проянить его**
 - Не рассматривается вопрос корректности и безопасности доставки сообщения от контроллера к mixer. **в рамках работы из упрощения заказ присылается через HTTP запрос, ответ выводится на connector в терминал**


## Архитектура работы системы
![DFD](./pics/dfd_task.png?raw=true "Потоки данных")
![DFD](./pics/dfd.png?raw=true "Архитектура")

1. Вся коммуникация между компонентами системы осуществляется через очереди сообщений.
2. Каждый компонент отвечает за свои собственные данные - расшаренных баз данных/общих файлов/информации нет.

### Компоненты
 - **BusinessRuleEngine (bre)** - сервис, отвечающий за хранение бизнес-правил и их выполнение относительно переданного запроса,содержащего перечни параметров оборудования и веществ.
 - **Document (document)** - сервис, отвечающий за хранение данных нормативных документов.
 - **Equipment (equipment)** - сервис, отвечающий за хранение списка оборудования и передачу команд и сигналов от контроллеров.
 - **MixtureOperator (mixer)** - сервис, позволяющий задавать параметры будущего смешивания и выбирать оборудование для него.
 - **ReportGenerator (reporter)** - сервис, генерирующий отчет по запрошенной операции смешивания.
 - **Storage (storage)** - сервис, отвечающий за хранение остатков веществ на складе.
 - **Monitor** -- авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае.
 - **Connector** -- выделенный с целью повышения возможностей безопасности модуль для связи с внешним миром на случай расширения функционала.



### Алгоритм работы решения


![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Обратим внимание на определенные по заданию доверенные и надежные компоненты - **message bus** и **monitor**. При этом считается, что все сообщения безальтернативно идут через **monitor**, который применяет политики безопасности. Этими двумя компонентами обеспечивается ЦБ по обеспечению конфиденциональности и целостности данных, передаваемых между компонентами системы.

Тогда прежде всего предлоположим, что будет, если компоненты перестанут выполнять возложенные на них функции в т.ч., допустим Remote Code Execute (RCE).

Тогда можно сразу обратить внимание, что компоненты **reporter** и **document** не оказывают влияния на систему и ее ЦБ (хотя формально влияет на ЦБ "Обеспечение целостности хранимых данных (баз данных и прочего).") и даже бизнес-функцию, поскольку не имеют направленных "внутрь" АСУ каналов и отвечают только за формирование сопроводительной документации, что не является критическим.

Поскольку есть ЦБ о невозможности подмены решения системы, то соответсвующему компоненту - **bre** придется верить, а следовательно разрабатывать его доверенным.

Кроме того, с параметром status работают еще и компонент-исполнитель **equipment**. Таким образом, чтобы выполнять бизнес-функцию, не допустить нарушения данной ЦБ, как и физических  последствий а ля взрыв, порча оборудования и т.д., необходимо его делать так же доверенным.

Компонент **storage** имеет критическое влияние на бизнес-функцию, но не на ЦБ системы, поскольку может не откладывать требуемое для операции количество производных, что заблокирует процесс выполнения. Таким образом, в доверенные его не добавляем.

Остается компонент **mixer** - его задача забронировать производные и оборудование, отправить запрос на выполнение операции, т.е. с точки зрения бизнес-функции он является одним из самых критичных в системе (по количеству операций бронирования). Кроме того, он является единственной точкой входа в систему извне. Таким образом, его взлом позволит забронировать все доступное оборудование в системе, все запасы товара, неверное количество производных (читай - взрыв), что приведет к невыполнению основной задачи АСУ. С целью избежать данной проблемы, но не делать его доверенным, необходимо использовать двустороннюю криптографию (**здесь предполагается использовать протокол Диффи-Хеллмана между отправителем и компонентом equipment, но времени на реализацию не хватило, хотя алгоритм детально описан в литературе и фактически без проблем реализуем в рамках работы командой**) т.е. на доверенном компоненте убеждаться, что сообщение содержит действительно те параметры, что переданы в компонент.

ЦБ "Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения." имеет в общем-то отношение ко всем копонентам, однако использование монитора безопасности подразумевает отсуствие у компонентов возможность связываться друг с другом напрямую, что обеспечивает наличие информации у компонента не более чем о той составляющей коммерческой тайны, которая ему требуется для выполнения функции. Данное правило может быть нарушено только при условии одновременной компроментации двух и более компонентов, о чем будет сказано далее.

**здесь про комбинацию взломанных компонентов**

На основе этих соображений, были определены доверенные компоненты и получена обновленная Sequence Diagramm, более пригодная к обеспечению безопасности функционирования при, собственно, неизменном функционале:

![Sequence diagram fixed](./pics/sd_fixed_upd.png?raw=true "Диаграмма вызовов обновленная")

Заказчиком были представлены наиболее волнующие его сценарии атаки, разберем их:
1. Подмена целиком или части ответа от любого из компонентов - приведет максимум к нарушению бизнес-функции, не решается никак, потому что 100% надежности не бывает, даже если все будет доверенным..
2. Взлом базы или баз любого из компонента - учтено в список сценариев.
3. Перехват информации, циркулирующей между компонентами - доверяем message bus.
4. Перехват информации в шине данных - доверяем message bus.
5. Отправка информации в шину данных неавторизованным компонентом - monitor не пропустит сообщение адресату.
6. Искажение информации в базах данных компонентов - здесь я склонен считать, что искажение может быть на стороне заказчика при несогласованном изменении данных, если же мы говорим о сопутсвующем работе искажении данных, например, их заменов, SQL-инъекцией и т.д., то это учтено в список сценариев.
7. Искажение работы BusinessRuleEngine - согласен, вписали его в доверенные, будем доверять и проверять.
8. Подмена передающихся между компонентами пакетов или их частей - неоднозначно, но можно считать, что учтено в список сценариев.
9. Подмена команд АСУ оборудованию смешивания компонентов - согласен, учтено в список сценариев.
10. Блокировка команд АСУ к оборудованию компонентов - согласен, учтено в список сценариев.
11. Блокировка обмена сообщений между компонентами - доверяем монитору.
12. Искажение введенной рецептуры - согласен, учтено в присок сценариев.

В результате произведенных над ней размышлений, были сформулированы **7** наиболее вероятных сценариев нарушения ЦБ:
1. Заказ прислан злоумышленником + взлом connector; **авторизация + меры безопасности**
2. Прислан новый заказ; **блокировка или работа в парараллель**
3. Компонент взломан и меняет параметры запроса; **подтверждение запроса - см. про криптографию + передавать только нужные поля, сохраняя остальные в доверенных компонентах**
4. Какой-то компонент взломан и саботирует работу - простаивает; **тут надо плакать**
5. Скрытые поля и их использование для code/sql injections; **валидация, экранирование**
6. Атака на "зависимости" - закладки в стороннем ПО, библиотеках; **локальные копии + проверка**
7. Неограниченное количество попыток на бронь оборудования/производных реагентов **спорный момент, зацикл?**

![Негативные сценарии](./pics/sd_fixed_upd_with_risks_upd.png?raw=true "Негативные сценарии")

**Отдельная диаграмма для первого негативного сценария - "чужого"" заказа:**
![Негативные сценарии](./pics/sd_rev_1.png?raw=true "")

Нарушается цель безопасности:
- Обеспечение доступности системы только для авторизованных лиц
Компенсируется использованием авторизации (реализовано "для вида") и криптографии + меры защиты на уровне сети и системы (out of scope).

**Отдельная диаграмма для второго негативного сценария - повторного заказа:**
![Негативные сценарии](./pics/sd_rev_2.png?raw=true "")

Нарушается цель безопасности:
- Исключение подмены решения системы.
- Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
- Обеспечение целостности хранимых данных (баз данных и прочего).
Компенсируется блокировкой данной возможности через монитор.

**Отдельная диаграмма для третьего негативного сценария - взлом отдельного компоненты и изменение им параметров запроса, подмена (частей) ответов:**
![Негативные сценарии](./pics/sd_rev_3.png?raw=true "")

Нарушается цель безопасности:
- Исключение подмены решения системы.
- Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
- Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения.
Компенсируется криптографией, см. выше, и, по возможности, передачей чувствительных данных только между доверенными компонентами.
Например, в случае запрошенной заказчиком архитектуры происходит постоянная передача чувствительных с точки зрения ЦБ данных между компонентами (всеми).
В реализованной мной системе максимально зарнесены потоки таких данных, однако остается, например, возможность сменить статус оборудования в недоверенном mixer, что нарушит ЦБ, однако, убирая этот этап в доверенный equipment я по сути лишаю полезного функционала mixer, что приводит к сильному изменению архитектуры, что я решил рассмотреть в отдельной версии решения.

**Отдельная диаграмма для четвертого негативного сценария - взлом отдельного компонента системы и его бездействие:**
![Негативные сценарии](./pics/sd_rev_4.png?raw=true "")

Нарушается бизнес-функция системы.
Компенсация представляется невозможной в рамках адекватных трудозатрат.

**Отдельная диаграмма для пятого негативного сценари - скрытых полей с управляющими командами для программных закладок/code-injection:**
![Негативные сценарии](./pics/sd_rev_5.png?raw=true "")

Могут быть нарушены все ЦБ системы.
Компенсация - строгая валидация входных параметров на соответсвие паттерну. Требует четкой проработки возможных форматов входных данных. На данный момент представлено поиском управляющих символов + по мелочам, см. первую политику.

**Отдельная диаграмма для шестого негативного сценария - атаки на зависимости:**
![Негативные сценарии](./pics/sd_rev_5.png?raw=true "")

Могуть быть нарушены все ЦБ.
Компенсация - локальные копии версий ПО и библиотек (считая, что заранее они не содержат закладки под наш новый продукт) можно проверять только обновления на "добавление подарков" (out of scope).

**Отдельная диаграмма для седьмого негативного сценария - неограниченного числа попыток бронирования оборудования:**
![Негативные сценарии](./pics/sd_rev_7.png?raw=true "")

Нарушается цель безопасности:
- Обеспечение целостности хранимых данных (баз данных и прочего).
И страдает бизнес-функция (впрочем, как и везде, но где указано - особенно).
Компенсация - валидация количества брони на один выделенный id и его соответсвие рецептуре, в т.ч. смотри криптографию.


### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем параграфе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **bre** и **equipment**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы вычислителя вердиктов возможности выполнения опреции и самому исполнителю.

![DFD-TCB](./pics/dfd_stepan_trusted.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механим верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.


### Политики безопасности


```python {lineNo:true}

ordering = False

def check_operation(id, details):
   global ordering
   authorized = False

   print(f"[info] checking policies for event {id},"\
         f" {details['source']}->{details['deliver_to']}: {details['operation']}")
   src = details['source']
   dst = details['deliver_to']
   operation = details['operation']
   if not ordering:
       if  src == 'connector' and dst == 'mixer' \
           and operation == 'ordering' and len(details) == 9 :
           #todo check content of another fields
           #now it helps, cause if another fields set will appear -
           #checking will be broken
           #generally, we can do it (and better case) as function to check each message between components
           check = 4
           for x in details['mix']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['amount']:
               if str(x).find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['from']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['using']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           if check==4:
               authorized = True
               ordering = True

   if src == 'mixer' and dst == 'equipment' \
       and operation == 'ask_equipment':
       authorized = True    
   if src == 'mixer' and dst == 'equipment' \
       and operation == 'equipment_status_req':
       authorized = True    
   if src == 'mixer' and dst == 'storage' \
       and operation == 'storage_book':
       authorized = True    
   if src == 'mixer' and dst == 'bre' \
       and operation == 'confirmation':
       authorized = True    
   if src == 'mixer' and dst == 'storage' \
       and operation == 'unblock':
       #and details['verified'] is True:
       authorized = True    
   if src == 'mixer' and dst == 'reporter' \
       and operation == 'operation_status':
       authorized = True    
   if src == 'mixer' and dst == 'storage' \
       and operation == 'decomission':
       authorized = True

   if src == 'storage' and dst == 'mixer' \
       and operation == 'storage_status':
       authorized = True    

   if src == 'equipment' and dst == 'mixer' \
       and operation == 'operation_status':
       authorized = True
   if src == 'equipment' and dst == 'mixer' \
       and operation == 'list_equipment':
       authorized = True
   if  src == 'equipment' and dst == 'mixer'\
       and operation == 'equipment_status':
       authorized = True

   if  src == 'document' and dst == 'reporter'\
       and operation == 'acts_req':
       authorized = True


   if  src == 'reporter' and dst == 'document'\
       and operation == 'need_acts':
       authorized = True
   if  src == 'reporter' and dst == 'connector'\
       and operation == 'acts':
       authorized = True
       ordering = False

   if  src == 'bre' and dst == 'mixer'\
       and operation == 'confirmation':
       authorized = True
   if  src == 'bre' and dst == 'equipment'\
       and operation == 'confirmation':
       authorized = True

   return authorized

```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке chemical-ICS с исходным кодом выполнить

**make run**
или **docker-compose up -d**

Примечание: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу 1-2 минуты

запуск тестов (на данный момент отсутсвуют):
**make test**
или **pytest**
