# Отчёт о выполнении задачи "Chemical-ICS"

- [Отчёт о выполнении задачи "Chemical-ICS"](#отчёт-о-выполнении-задачи-chemical-ics)
  - [Постановка задачи](#постановка-задачи)
  - [Общий алгоритм работы системы](#общий-алгоритм-работы-системы)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
  Для автоматизации работы с опасными химическими веществами на произвостве и снижения числа человеческих ошибок, приводящих к авариям, необходимо разработать прототип киберимунной АСУ смешивания компонентов (далее - АСУ), которая сможет проверять доступность требуемого в операции оборудования, соответсвие введенных рецептур установленным нормам и тех.процессу и по итогу отдавать команды на работу с реактивами.

## Общий алгоритм работы системы
1. Контролер составляет рецептуру, указывая вещества для смешивания и требуемое оборудование (out of scope).
2. Контролер вводит в АСУ рецептуру.
3. АСУ проверяет допустимость смешивания веществ между собой и допустимость смешивания на выбранном оборудовании: проведение операции или отказ.
4. АСУ печатает отчет об операции: идентификационные данные, сведения о используемых веществах и оборудовании, список проверенных норм с примечанием о (не)соответсвии норме.

## Известные ограничения и вводные

  По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.

### Цели и Предположения Безопасности (ЦПБ)
**Цели безопасности:**
  - Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения.
  - Обеспечение целостности хранимых данных (баз данных и прочего).
  - Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
  - Исключение подмены решения системы.

**Предположения безопасности:**
 - Отсутсвует физическое воздействие на компоненты.**Но не доступ, верно?**
 - Отказоустойчивость компонента гарантируется самим компонентом. **Вот тут, наверное, прояснить бы**
 - Не рассматривается вопрос корректности и безопасности доставки сообщения от контроллера к mixer.
**mixer получает заказ онлайн или физически?**


## Архитектура работы системы

![DFD](./pics/dfd.png?raw=true "Архитектура")

1. Вся коммуникация между компонентами системы осуществляется через очереди сообщений.
2. Каждый компонент отвечает за свои собственные данные - расшаренных баз данных/общих файлов/информации нет.

### Компоненты
 - **BusinessRuleEngine (bre)** - сервис, отвечающий за хранение бизнес-правил и их выполнение относительно переданного запроса,содержащего перечни параметров оборудования и веществ.
 - **Document (document)** - сервис, отвечающий за хранение данных нормативных документов.
 - **Equipment (equipment)** - сервис, отвечающий за хранение списка оборудования и передачу команд и сигналов от контроллеров.
 - **MixtureOperator (mixer)** - сервис, позволяющий задавать параметры будущего смешивания и выбирать оборудование для него.
 - **ReportGenerator (reporter)** - сервис, генерирующий отчет по запрошенной операции смешивания.
 - **Storage (storage)** - сервис, отвечающий за хранение остатков веществ на складе.
 - **Monitor** -- **adding soon**



### Алгоритм работы решения


![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Обратим внимание на определенные по заданию **ведь правда?** доверенные и надежные компоненты - **message bus** и **monitor**. При этом считаем, что все сообщения идут через **monitor**, который применяет политики безопасности. Этими двумя компонентами обеспечивается ЦБ по обеспечению конфиденциональности и целостности данных, передаваемых между компонентами системы.

Тогда прежде всего предлоположим, что будет, если компоненты перестанут выполнять возложенные на них функции в т.ч., допустим Remote Code Execute (RCE).

Тогда можно сразу обратить внимание, что компоненты **reporter** и **document** не оказывают влияния на систему и ее ЦБ (хотя формально влияет на ЦБ "Обеспечение целостности хранимых данных (баз данных и прочего).") и даже бизнес-функцию, поскольку не имеют направленных "внутрь" АСУ каналов и отвечают только за формирование сопроводительной документации, что не является критическим.

Поскольку есть ЦБ о невозможности подмены решения системы, то соответсвующему компоненту - **bre** придется верить, а следовательно разрабатывать его доверенным.

**Может ли недостаток материала сказаться на системе?**

Кроме того, с параметром status работают еще и компонент-исполнитель **equipment**. Таким образом, чтобы выполнять бизнес-функцию, не допустить нарушения данной ЦБ, как и физических  последствий а ля взрыв, порча оборудования и т.д., необходимо его делать так же доверенным.

Компонент **storage** имеет критическое влияние на бизнес-функцию, но не на ЦБ системы, поскольку может не откладывать требуемое для операции количество производных, что заблокирует процесс выполнения. Таким образом, в доверенные его не добавляем.

Остается компонент mixer - его задача забронировать производные и оборудование, отправить запрос на выполнение операции, т.е. с точки зрения бизнес-функции он является одним из самых критичных в системе (по количеству операций бронирования). Кроме того, он является единственной точкой входа в систему извне. Таким образом, его взлом позволит забронировать все доступное оборудование в системе, все запасы товара, неверное количество производных (читай - взрыв), что приведет к невыполнению основной задачи АСУ. С целью избежать данной проблемы, но не делать его доверенным, необходимо использовать двустороннюю криптографию (**эх, кто бы меня в нее посвятил**) т.е. на доверенном компоненте убеждаться, что сообщение содержит действительно те параметры, что переданы в компонент.

ЦБ "Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения." имеет в общем-то отношение ко всем копонентам, однако использование монитора безопасности подразумевает отсуствие у компонентов возможность связываться друг с другом напрямую, что обеспечивает наличие информации у компонента не более чем о той составляющей коммерческой тайны, которая ему требуется для выполнения функции. Данное правило может быть нарушено только при условии одновременной компроментации двух и более компонентов, о чем будет сказано далее.

**можно ли из комбинаций взломанных компонентов убирать доверенные, т.к. они и так признаны критическими? Вообще, вероятно, да**

**здесь про комбинацию взломанных компонентов**

**с хранилищем связаны и equip и mixer - зачем + статус заказа передается в mixer**
На основе этих соображений, были определены доверенные компоненты и получена обновленная Sequence Diagramm, более пригодная к обеспечению безопасности функционирования при, собственно, неизменном функционале:

![Sequence diagram fixed](./pics/sd_fixed.png?raw=true "Диаграмма вызовов обновленная")

Заказчиком были представлены наиболее волнующие его сценарии атаки, разберем их:
1. Подмена целиком или части ответа от любого из компонентов - печально, но приведет максимум к нарушению бизнес-функции, не решается никак, потому что 100% надежности не бывает, даже если все будет доверенным..
2. Взлом базы или баз любого из компонента - согласен, учтено в список сценариев.
3. Перехват информации, циркулирующей между компонентами - доверяем message bus.
4. Перехват информации в шине данных - доверяем message bus.
5. Отправка информации в шину данных неавторизованным компонентом - monitor не пропустит сообщение адресату. Есть, конечно, вариант, задудосить его, это **вопрос**
6. Искажение информации в базах данных компонентов. **искажение в силу взлома? Так это дубль. Искажение еще "на входе"/при обновлении? А меня тоже интересует, но out of scope, кажется.**
7. Искажение работы BusinessRuleEngine - согласен, вписали его в доверенные, будем доверять и проверять.
8. Подмена передающихся между компонентами пакетов или их частей - неоднозначно, но можно считать, что учтено в список сценариев.
9. Подмена команд АСУ оборудованию смешивания компонентов - согласен, учтено в список сценариев.
10. Блокировка команд АСУ к оборудованию компонентов - согласен, учтено в список сценариев.
11. Блокировка обмена сообщений между компонентами - доверяем монитору.
12. Искажение введенной рецептуры - согласен, учтено в присок сценариев.

В результате произведенных над ней размышлений, были сформулированы **X** наиболее вероятных сценариев нарушения ЦБ:
1. Заказ прислан злоумышленником. **авторизация**
2. Прислан новый заказ. **блокировка или работа в парараллель**
3. Mixer взломан и меняет параметры запроса - (идентичная ситуация с equipment и storage) **подтверждение запроса**
4. Mixer взломан и не отправляет задачу на выполнение **линия стоит, люди бегают, звонят в Лабораторию и кричат, что Fishonground нехороший человек** - возможно, нужен компонент-контроллер, т.к. двойная ошибка маловероятна + можно свалить это в монитор, ну, хотя бы проверку - мы же видим, что статус успешно прошел
5. Какой-то компонент взломан и саботирует работу - простаивает. **вообще хз, что тут можно сделать - deadlock получается**
6. Скрытые поля и их использование для code/sql injections;
7. Взлом mixer как открытой точки доступа в сеть**?**
8. Атака на "водопой" - закладки в стороннем ПО
9. Неограниченное количество попыток на бронь оборудования/производных реагентов.

8. Экранирование?
9. Дудос кафки
10. еще раз прочитать безопансого менеджера и безопасное логгирование


Ниже выбранные сценарии компрометации целей безопасности представлены на диаграмме процесса работы:

![Негативные сценарии](./pics/sd_fixed_with_risks.png?raw=true "Негативные сценарии")

**Отдельная диаграмма для первого негативного сценария - :**
![Негативные сценарии](./pics/sd_rev_1.png?raw=true "")

**Отдельная диаграмма для второго негативного сценария -:**
![Негативные сценарии](./pics/sd_rev_2.png?raw=true "")


**Отдельная диаграмма для третьего негативного сценария - :**
![Негативные сценарии](./pics/sd_rev_3.png?raw=true "")


**Отдельная диаграмма для четвертого негативного сценария - :**
![Негативные сценарии](./pics/sd_rev_4.png?raw=true "")

**Отдельная диаграмма для пятого негативного сценари- :**
![Негативные сценарии](./pics/sd_rev_5.png?raw=true "")


**Отдельная диаграмма для шестого негативного сценария - :**
![Негативные сценарии](./pics/sd_rev_6.png?raw=true "")




### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем параграфе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **bre** и **equipment**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы вычислителя вердиктов возможности выполнения опреции и самому исполнителю.

![DFD-TCB](./pics/dfd_stepan_trusted.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механим верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.


### Политики безопасности


```python {lineNo:true}

 //somecodeishere

```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке secure-update с исходным кодом выполнить

**make run**
или **docker-compose up -d**

Примечание: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу 1-2 минуты

запуск тестов (на данный момент отсутсвуют):
**make test**
или **pytest**
