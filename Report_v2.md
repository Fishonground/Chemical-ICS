# Отчёт о выполнении задачи "Chemical-ICS"

- [Отчёт о выполнении задачи "Chemical-ICS"](#отчёт-о-выполнении-задачи-chemical-ics)
  - [Постановка задачи](#постановка-задачи)
  - [Общий алгоритм работы системы](#общий-алгоритм-работы-системы)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Известные проблемы реализации](#известные-проблемы-реализации)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
  Для автоматизации работы с опасными химическими веществами на произвостве и снижения числа человеческих ошибок, приводящих к авариям, необходимо разработать прототип киберимунной АСУ смешивания компонентов (далее - АСУ), которая сможет проверять доступность требуемого в операции оборудования, соответсвие введенных рецептур установленным нормам и тех.процессу и по итогу отдавать команды на работу с реактивами.

## Общий алгоритм работы системы
1. Контролер составляет рецептуру, указывая вещества для смешивания и требуемое оборудование (out of scope).
2. Контролер вводит в АСУ рецептуру.
3. АСУ проверяет допустимость смешивания веществ между собой и допустимость смешивания на выбранном оборудовании: проведение операции или отказ.
4. АСУ печатает отчет об операции: идентификационные данные, сведения о используемых веществах и оборудовании, список проверенных норм с примечанием о (не)соответсвии норме.

## Известные ограничения и вводные

  По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.

### Цели и Предположения Безопасности (ЦПБ)
**Бизнес-цель:**
  - Выполнение заказа
**Цели безопасности:**
  - Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения.
  - Обеспечение целостности хранимых данных (баз данных и прочего).
  - Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
  - Исключение подмены решения системы.
  - Обеспечение доступности системы только для авторизованных лиц

**Предположения безопасности:**
 - Отсутсвует физическое воздействие на компоненты.
 - Отказоустойчивость компонента гарантируется самим компонентом. **Недостаточно четкий момент в постановке задачи, в дальнейшем хотелось бы проянить его**
 - Не рассматривается вопрос корректности и безопасности доставки сообщения от контроллера к mixer. **в рамках работы из упрощения заказ присылается через HTTP запрос, ответ выводится на connector в терминал**


## Архитектура работы системы
![DFD](./pics/dataflow_task.png?raw=true "Потоки данных")
![DFD_2](./pics/dfd.png?raw=true "Архитектура")

1. Вся коммуникация между компонентами системы осуществляется через очереди сообщений.
2. Каждый компонент отвечает за свои собственные данные - расшаренных баз данных/общих файлов/информации нет.

### Компоненты
 - **BusinessRuleEngine (bre)** - сервис, отвечающий за хранение бизнес-правил и их выполнение относительно переданного запроса,содержащего перечни параметров оборудования и веществ.
 - **Document (document)** - сервис, отвечающий за хранение данных нормативных документов.
 - **Equipment (equipment)** - сервис, отвечающий за хранение списка оборудования и передачу команд и сигналов от контроллеров.
 - **ReportGenerator (reporter)** - сервис, генерирующий отчет по запрошенной операции смешивания.
 - **Storage (storage)** - сервис, отвечающий за хранение остатков веществ на складе.
 - **Monitor** -- авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае.
 - **Connector** -- выделенный с целью повышения возможностей безопасности модуль для связи с внешним миром на случай расширения функционала.

### Алгоритм работы решения

**Как было изначально:**
![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

**Как стало после осмысления:**
![Sequence diagram_2](./pics/sd_v2.png?raw=true "Диаграмма вызовов")

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Обратим внимание на определенные по заданию доверенные и надежные компоненты - **message bus** и **monitor**. При этом считается, что все сообщения безальтернативно идут через **monitor**, который применяет политики безопасности. Этими двумя компонентами обеспечивается ЦБ по обеспечению конфиденциональности и целостности данных, передаваемых между компонентами системы.

В предложенной архитектуре критическими являются только компоненты **equipment** и **bre** - они отвечают за обработку "чувствительных" данных, т.е. правил, применямых на производстве, обработку решений, принимаемых в системе.

Тогда можно сразу обратить внимание, что компонент **document** не оказывает влияния на систему и ее ЦБ (хотя формально влияет на ЦБ "Обеспечение целостности хранимых данных (баз данных и прочего).") и даже бизнес-функцию, поскольку не имеют направленных "внутрь" АСУ каналов и отвечают только за формирование сопроводительной документации, что не является критическим для работы системы + туда не попадают никакие лишние данные от других компонентов.

Аналогичная ситуация с компонентом **storage** - потенциальная угроза только собственной базе данных + бизнес функции. В то же время, ничего узнать о работе системы он не сможет.

Остается вопрос к **reporter** - в задуманной по умолчанию реализации системы этот недоверенный компонент позволяет получать данные о правилах, применяемых в системе, что дает ему возможность нарушить ЦБ -> было решено ограничить его в этом и не передавать, например, статус оборудования при производстве (чтобы сохранять rules_check_result) в отчете. Тогда получается, что все чувствительные данные в безопасности.

Здесь, безусловно, есть некоторое лукавство - вынеся функции mixer в equipment с прошлой версии я не сделал затраты на проверку меньше в два раза (как если бы делать доверенными equipment и mixer(что очень хотелось) там, и только equipment тут), однако посчитав количество исходящих в иные компоненты сообщений (т.е. грубо говоря, управляющих сигналов), можно заметить, что их было 6 (mixer) и 3 (equipment), а стало 4 (equipment) при более комфортной для обеспечения ЦБ архитектуре. Выгода значительная, при, впрочем, росте затрат на проверку. А политик было 17, а стало 11.

Здесь все еще предполагается использовать криптографию, например Диффи-Хеллмана, между Controller и Equipment, чтобы пройти через недоверенный connector.

ЦБ "Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения." имеет в общем-то отношение ко всем копонентам, однако использование монитора безопасности подразумевает отсуствие у компонентов возможность связываться друг с другом напрямую и строгий контроль передаваемых полей, обеспечивают наличие информации у компонента не более чем о той составляющей коммерческой тайны, которая ему требуется для выполнения функции. В текущем варианте системы данное правило не может быть нарушено и при условии одновременной компроментации двух и более компонентов (не из числа доверенных), о чем будет сказано далее.

Резюмируя:
Компоненты monitor, equipment и bre доверенные, т.к. их компроментация имеет критическое влияние на ЦБ и бизнес-функцию.
Компоненты reporter и document, connector, storage имеют влияние на бизнес-функцию и потенциально могут нарушать некоторые ЦБ, однако их влияние не будет являться (с моей точки зрения) настолько критическим, чтобы делать их доверенными, и при грамотной реализации становится возможным минимизировать их потенциальное влияние на систему.
Наиболее реальным и осуществимым сценарием атаки (и в то же время, наимее компенсируемым) все еще представляется атака типа "отказ в обслуживании", достичь которую может формально компроментация любого из компонентов и, даже, ошибка в реализации/входных данных.

Говоря о сочетании взломанных компонентов, не будем учитывать указанные доверенными компоненты - об их важности уже все ясно, т.е. остаются reporter, document, connector и storage.
Storage связана только с equipment, т.е. может только усугубить проблему при взломе доверенного компонента/вызвать dos.
Остальные компоненты связаны по схеме connector <-- reporter <--> document, т.е. могут быть связаны, но document не содержит критически важных данных, а reporter + connector хоть и могут позволить осуществлять передачу, например, всех доступных внутренних данных (т.е. какие правила (номера) взяты из каких нормативных актов + статус их проверки -> т.е. затруднен реверс относительно фактически сравниваемых значений) злоумышленнику, не отвлекаясь от выполнения "полезной" работы. Это еще нарушает ЦБ и несет угрозу, может компенсироваться мерами по безопасности сети (связь только с доверенными адресами), но в уже гораздо меньшей степени.

Заказчиком были представлены наиболее волнующие его сценарии атаки, разберем их:
1. Подмена целиком или части ответа от любого из компонентов - приведет максимум к нарушению бизнес-функции, поскольку storage может не выделить компоненты, а reporter не отдать отчет.
2. Взлом базы или баз любого из компонента - учтено в список сценариев.
3. Перехват информации, циркулирующей между компонентами - доверяем message bus.
4. Перехват информации в шине данных - доверяем message bus.
5. Отправка информации в шину данных неавторизованным компонентом - monitor не пропустит сообщение адресату.
6. Искажение информации в базах данных компонентов - здесь я склонен считать, что искажение может быть на стороне заказчика при несогласованном изменении данных, если же мы говорим о сопутсвующем работе искажении данных, например, их замены, SQL-инъекцией и т.д., то это учтено в список сценариев.
7. Искажение работы BusinessRuleEngine - согласен, вписали его в доверенные, будем доверять и проверять.
8. Подмена передающихся между компонентами пакетов или их частей - практически невозможно вне доверенных компонентов в данной системе, кроме п.1.
9. Подмена команд АСУ оборудованию смешивания компонентов - участвуют только доверенные компоненты.
10. Блокировка команд АСУ к оборудованию компонентов - согласен, учтено в список сценариев.
11. Блокировка обмена сообщений между компонентами - доверяем монитору.
12. Искажение введенной рецептуры - здесь, при использовании криптографии, весьма затруднительно.

**Здесь, конечно, можно сказать, что склад выдаст нам не те компоненты, тогда его тоже придется делать доверенным. А еще можно подумать, что есть склад веществ и оборудования, а почему бы их не объединить, а логику вывести в mixer обратно - все равно будет +1 доверенный компонент, но это софистика и кажется, идеал недостижим - мне нравится текущая схема своей организацией. Не приди она мне в голову слишком поздно и не отличайся радикально от заданной изначально - я бы сразу ее реализовывал.**


В результате произведенных над ней размышлений, наиболее вероятные сценарии нарушения ЦБ практически не изменились:
1. Заказ прислан злоумышленником + взлом connector; **авторизация + меры безопасности**
2. Прислан новый заказ; **блокировка**
3. Компонент взломан и меняет параметры запроса; **только в storage могут быть вопросы**
4. Какой-то компонент взломан и саботирует работу - простаивает; **тут все еще надо плакать**
5. Скрытые поля и их использование для code/sql injections; **валидация, экранирование**
6. Атака на "зависимости" - закладки в стороннем ПО, библиотеках; **локальные копии + проверка обновлений**
7. Неограниченное количество попыток на бронь оборудования/производных реагентов **в текущей реализации эта проблема минимальна**

![Негативные сценарии](./pics/sd_v2_risks.png?raw=true "Негативные сценарии")

**Отдельная диаграмма для первого негативного сценария - "чужого"" заказа:**
![Негативные сценарии](./pics/sd_rev2_1.png?raw=true "")

Нарушается цель безопасности:
- Обеспечение доступности системы только для авторизованных лиц
Компенсируется использованием авторизации (реализовано "для вида") и криптографии + меры защиты на уровне сети и системы (out of scope).

**Отдельная диаграмма для второго негативного сценария - повторного заказа:**
![Негативные сценарии](./pics/sd_rev2_2.png?raw=true "")

Нарушается цель безопасности:
- Исключение подмены решения системы.
- Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
- Обеспечение целостности хранимых данных (баз данных и прочего).
Компенсируется блокировкой данной возможности через монитор (реализовано).

**Отдельная диаграмма для третьего негативного сценария - взлом отдельного компоненты и изменение им параметров запроса, подмена (частей) ответов:**
![Негативные сценарии](./pics/sd_rev2_3.png?raw=true "")

Нарушается цель безопасности:
- Исключение подмены решения системы.
- Обеспечение конфиденциональности и целостности данных передаваемых между компонентами системы.
- Обеспечение сохранности коммерческой тайны об имеющихся веществах, оборудовании, остатках, действующих на производстве правилах смешения.
Компенсируется криптографией, см. выше, и, по возможности, передачей чувствительных данных только между доверенными компонентами (частично компенсировано by design).
Например, в случае запрошенной заказчиком архитектуры происходит постоянная передача чувствительных с точки зрения ЦБ данных между компонентами (всеми).
В реализованной мной системе максимально зарнесены потоки таких данных, однако остается, например, возможность сменить статус оборудования в недоверенном mixer, что нарушит ЦБ, однако, убирая этот этап в доверенный equipment я по сути лишаю полезного функционала mixer, что приводит к сильному изменению архитектуры, что я решил рассмотреть в отдельной версии решения.

**Отдельная диаграмма для четвертого негативного сценария - взлом отдельного компонента системы и его бездействие:**
![Негативные сценарии](./pics/sd_rev2_4.png?raw=true "")

Нарушается бизнес-функция системы.
Компенсация представляется невозможной в рамках адекватных трудозатрат.

**Отдельная диаграмма для пятого негативного сценари - скрытых полей с управляющими командами для программных закладок/code-injection:**
![Негативные сценарии](./pics/sd_rev2_5.png?raw=true "")

Могут быть нарушены все ЦБ системы.
Компенсация - строгая валидация входных параметров на соответсвие паттерну. Требует четкой проработки возможных форматов входных данных. На данный момент представлено поиском управляющих символов + по мелочам, см. первую политику.

**Отдельная диаграмма для шестого негативного сценария - атаки на зависимости:**
![Негативные сценарии](./pics/sd_rev2_5.png?raw=true "")

Могуть быть нарушены все ЦБ.
Компенсация - локальные копии версий ПО и библиотек (считая, что заранее они не содержат закладки под наш новый продукт) можно проверять только обновления на "добавление подарков" (out of scope).

**Отдельная диаграмма для седьмого негативного сценария - неограниченного числа попыток бронирования оборудования:**
![Негативные сценарии](./pics/sd_rev2_7.png?raw=true "")

Нарушается цель безопасности:
- Обеспечение целостности хранимых данных (баз данных и прочего).
И страдает бизнес-функция (впрочем, как и везде, но где указано - особенно).
Компенсация - валидация количества брони на один выделенный id и его соответсвие рецептуре, в т.ч. смотри криптографию.


### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем параграфе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **bre** и **equipment**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы вычислителя вердиктов возможности выполнения опреции и самому исполнителю.

![DFD-TCB](./pics/dfd_v2.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механим верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.

### Известные проблемы реализации
- В общем-то существует только на бумаге, но можно очень быстро пересобрать из версии 1, благо сам функционал не менялся - его надо по файликам разнести только.
+ все старое:
- Проблема с Правилом номер 2 (исключено из реализации, чтобы не выглядело совсем костыльно, потому что нормально - слишком долго)
- Проблема sleep -> copy
- Сервер для приема результата
- Прерывание работающего потока equipment в процессе смешения?
- Реализация повторных запросов к компонентам из mixing при ошибках?
- Отсуствуют тесты (на текущий момент)

### Политики безопасности


```python {lineNo:true}

ordering = False

def check_operation(id, details):
   global ordering
   authorized = False

   print(f"[info] checking policies for event {id},"\
         f" {details['source']}->{details['deliver_to']}: {details['operation']}")
   src = details['source']
   dst = details['deliver_to']
   operation = details['operation']
   if not ordering:
       if  src == 'connector' and dst == 'equipment' \
           and operation == 'ordering' and len(details) == 9 :
           #todo check content of another fields
           #now it helps, cause if another fields set will appear -
           #checking will be broken
           #generally, we can do it (and better case) as function to check each message between components
           check = 4
           for x in details['mix']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['amount']:
               if str(x).find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['from']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           for x in details['using']:
               if x.find(';')>=0:
                   print('SQL injection found!')
                   check-=1
           if check==4:
               authorized = True
               ordering = True


   if src == 'storage' and dst == 'equipment' \
       and operation == 'storage_status':
       authorized = True    

   if src == 'equipment' and dst == 'reporter' \
       and operation == 'operation_status':
       authorized = True
   if src == 'equipment' and dst == 'storage' \
       and operation == 'storage_book':
       authorized = True    
   if src == 'equipment' and dst == 'bre' \
       and operation == 'confirmation':
       authorized = True    
   if src == 'equipment' and dst == 'storage' \
       and operation == 'unblock':
       #and details['verified'] is True:
       authorized = True    
   if src == 'equipment' and dst == 'storage' \
       and operation == 'decomission':
       authorized = True

   if  src == 'document' and dst == 'reporter'\
       and operation == 'acts_req':
       authorized = True


   if  src == 'reporter' and dst == 'document'\
       and operation == 'need_acts':
       authorized = True
   if  src == 'reporter' and dst == 'connector'\
       and operation == 'acts':
       authorized = True
       ordering = False

   if  src == 'bre' and dst == 'equipment'\
       and operation == 'confirmation':
       authorized = True

   return authorized

```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке chemical-ICS с исходным кодом выполнить

**make run**
или **docker-compose up -d**

Примечание: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу 1-2 минуты

запуск тестов (на данный момент отсутсвуют):
**make test**
или **pytest**
